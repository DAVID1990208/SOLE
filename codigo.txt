##main.py##
from fastapi import FastAPI, Depends, HTTPException, status, Request, Form, UploadFile, File
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi.responses import HTMLResponse, RedirectResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from sqlalchemy import create_engine, Column, Integer, String, LargeBinary, Float, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session
from passlib.context import CryptContext
from jose import JWTError, jwt
from datetime import datetime, timedelta
from pydantic import BaseModel, EmailStr
from typing import Optional, List
import secrets
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
import base64

# Configuración
SECRET_KEY = os.getenv("SECRET_KEY", secrets.token_urlsafe(32))
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60

# SMTP Config (usa variables de entorno en producción)
SMTP_SERVER = os.getenv("SMTP_SERVER", "smtp.gmail.com")
SMTP_PORT = int(os.getenv("SMTP_PORT", 587))
SMTP_USER = os.getenv("SMTP_USER", "tu_email@gmail.com")
SMTP_PASSWORD = os.getenv("SMTP_PASSWORD", "tu_password")
BASE_URL = os.getenv("BASE_URL", "http://localhost:8000")

# Base de datos
SQLALCHEMY_DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(SQLALCHEMY_DATABASE_URL)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

# Modelos de base de datos
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True)
    username = Column(String, unique=True, index=True)
    hashed_password = Column(String)
    reset_token = Column(String, nullable=True)
    reset_token_expiry = Column(String, nullable=True)

class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(Text, nullable=True)
    price = Column(Float, nullable=True)
    image_data = Column(LargeBinary)

class SiteConfig(Base):
    __tablename__ = "site_config"
    id = Column(Integer, primary_key=True, index=True)
    primary_color = Column(String, default="#ff6b9d")
    background_color = Column(String, default="#fff5f8")
    product_bg_color = Column(String, default="#ffffff")
    whatsapp_number = Column(String, default="1121820759")  # ← NUEVO


Base.metadata.create_all(bind=engine)

# FastAPI App
app = FastAPI(title="El Rincón de la Sole")
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

# Seguridad
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
security = HTTPBearer()

# Pydantic Models
class UserCreate(BaseModel):
    username: str
    email: EmailStr
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class Token(BaseModel):
    access_token: str
    token_type: str

class PasswordResetRequest(BaseModel):
    email: EmailStr

class PasswordReset(BaseModel):
    token: str
    new_password: str

class ProductCreate(BaseModel):
    name: str
    description: Optional[str] = None
    price: Optional[float] = None

class SiteConfigUpdate(BaseModel):
    primary_color: Optional[str] = None
    background_color: Optional[str] = None
    product_bg_color: Optional[str] = None
    whatsapp_number: Optional[str] = None   # ← NUEVO

# Dependencias
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password):
    return pwd_context.hash(password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security), db: Session = Depends(get_db)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        token = credentials.credentials
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    user = db.query(User).filter(User.username == username).first()
    if user is None:
        raise credentials_exception
    return user

def send_email(to_email: str, subject: str, body: str):
    try:
        msg = MIMEMultipart()
        msg['From'] = SMTP_USER
        msg['To'] = to_email
        msg['Subject'] = subject
        msg.attach(MIMEText(body, 'html'))
        
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.starttls()
        server.login(SMTP_USER, SMTP_PASSWORD)
        server.send_message(msg)
        server.quit()
        return True
    except Exception as e:
        print(f"Error sending email: {e}")
        return False

# Inicializar configuración por defecto
def init_default_config(db: Session):
    config = db.query(SiteConfig).first()
    if not config:
        config = SiteConfig()
        db.add(config)
        db.commit()

# Routes - Frontend
@app.get("/", response_class=HTMLResponse)
async def home(request: Request, db: Session = Depends(get_db)):
    init_default_config(db)
    products = db.query(Product).all()
    config = db.query(SiteConfig).first()
    
    products_data = []
    for p in products:
        products_data.append({
            "id": p.id,
            "name": p.name,
            "description": p.description,
            "price": p.price,
            "image": base64.b64encode(p.image_data).decode() if p.image_data else None
        })
    
    return templates.TemplateResponse("index.html", {
        "request": request,
        "products": products_data,
        "config": config
    })

@app.get("/login", response_class=HTMLResponse)
async def login_page(request: Request):
    return templates.TemplateResponse("login.html", {"request": request})

@app.get("/forgot-password", response_class=HTMLResponse)
async def forgot_password_page(request: Request):
    return templates.TemplateResponse("forgot_password.html", {"request": request})

@app.get("/reset-password/{token}", response_class=HTMLResponse)
async def reset_password_page(request: Request, token: str):
    return templates.TemplateResponse("reset_password.html", {"request": request, "token": token})

@app.get("/dashboard", response_class=HTMLResponse)
async def dashboard_page(request: Request):
    return templates.TemplateResponse("dashboard.html", {"request": request})

# API Routes - Auth
@app.post("/api/register", response_model=Token)
async def register(user: UserCreate, db: Session = Depends(get_db)):
    db_user = db.query(User).filter((User.email == user.email) | (User.username == user.username)).first()
    if db_user:
        raise HTTPException(status_code=400, detail="Email or username already registered")
    
    hashed_password = get_password_hash(user.password)
    db_user = User(email=user.email, username=user.username, hashed_password=hashed_password)
    db.add(db_user)
    db.commit()
    
    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    access_token = create_access_token(
        data={"sub": user.username}, expires_delta=access_token_expires
    )
    return {"access_token": access_token, "token_type": "bearer"}

@app.post("/api/login", response_model=Token)
async def login(user: UserLogin, db: Session = Depends(get_db)):
    db_user = db.query(User).filter(User.username == user.username).first()
    if not db_user or not verify_password(user.password, db_user.hashed_password):
        raise HTTPException(status_code=401, detail="Incorrect username or password")
    
    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    access_token = create_access_token(
        data={"sub": user.username}, expires_delta=access_token_expires
    )
    return {"access_token": access_token, "token_type": "bearer"}

@app.post("/api/forgot-password")
async def forgot_password(request: PasswordResetRequest, db: Session = Depends(get_db)):
    user = db.query(User).filter(User.email == request.email).first()
    if not user:
        return {"message": "If the email exists, a reset link will be sent"}
    
    reset_token = secrets.token_urlsafe(32)
    expiry = (datetime.utcnow() + timedelta(hours=1)).isoformat()
    
    user.reset_token = reset_token
    user.reset_token_expiry = expiry
    db.commit()
    
    reset_link = f"{BASE_URL}/reset-password/{reset_token}"
    email_body = f"""
    <html>
        <body>
            <h2>Restablecer Contraseña - El Rincón de la Sole</h2>
            <p>Hola {user.username},</p>
            <p>Has solicitado restablecer tu contraseña. Haz clic en el siguiente enlace para continuar:</p>
            <a href="{reset_link}">Restablecer contraseña</a>
            <p>Este enlace expirará en 1 hora.</p>
            <p>Si no solicitaste esto, ignora este correo.</p>
        </body>
    </html>
    """
    
    send_email(user.email, "Restablecer Contraseña", email_body)
    return {"message": "If the email exists, a reset link will be sent"}

@app.post("/api/reset-password")
async def reset_password(reset: PasswordReset, db: Session = Depends(get_db)):
    user = db.query(User).filter(User.reset_token == reset.token).first()
    if not user or not user.reset_token_expiry:
        raise HTTPException(status_code=400, detail="Invalid or expired token")
    
    expiry = datetime.fromisoformat(user.reset_token_expiry)
    if datetime.utcnow() > expiry:
        raise HTTPException(status_code=400, detail="Token has expired")
    
    user.hashed_password = get_password_hash(reset.new_password)
    user.reset_token = None
    user.reset_token_expiry = None
    db.commit()
    
    return {"message": "Password reset successful"}

# API Routes - Products (Protected)
@app.get("/api/products")
async def get_products(db: Session = Depends(get_db)):
    products = db.query(Product).all()
    result = []
    for p in products:
        result.append({
            "id": p.id,
            "name": p.name,
            "description": p.description,
            "price": p.price,
            "image": base64.b64encode(p.image_data).decode() if p.image_data else None
        })
    return result

@app.post("/api/products")
async def create_product(
    name: str = Form(...),
    description: Optional[str] = Form(None),
    price: Optional[float] = Form(None),
    image: UploadFile = File(...),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    image_data = await image.read()
    product = Product(name=name, description=description, price=price, image_data=image_data)
    db.add(product)
    db.commit()
    db.refresh(product)
    return {"id": product.id, "message": "Product created successfully"}

@app.put("/api/products/{product_id}")
async def update_product(
    product_id: int,
    name: Optional[str] = Form(None),
    description: Optional[str] = Form(None),
    price: Optional[float] = Form(None),
    image: Optional[UploadFile] = File(None),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    product = db.query(Product).filter(Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    if name:
        product.name = name
    if description is not None:
        product.description = description
    if price is not None:
        product.price = price
    if image:
        product.image_data = await image.read()
    
    db.commit()
    return {"message": "Product updated successfully"}

@app.delete("/api/products/{product_id}")
async def delete_product(
    product_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    product = db.query(Product).filter(Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    db.delete(product)
    db.commit()
    return {"message": "Product deleted successfully"}

# API Routes - Site Config (Protected)
@app.get("/api/config")
async def get_config(db: Session = Depends(get_db)):
    init_default_config(db)
    config = db.query(SiteConfig).first()
    return {
        "primary_color": config.primary_color,
        "background_color": config.background_color,
        "product_bg_color": config.product_bg_color,
        "whatsapp_number": config.whatsapp_number  # ← NUEVO
    }

@app.put("/api/config")
async def update_config(
    config_update: SiteConfigUpdate,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    config = db.query(SiteConfig).first()
    if not config:
        config = SiteConfig()
        db.add(config)
    
    if config_update.primary_color:
        config.primary_color = config_update.primary_color
    if config_update.background_color:
        config.background_color = config_update.background_color
    if config_update.product_bg_color:
        config.product_bg_color = config_update.product_bg_color
    if config_update.whatsapp_number:
        config.whatsapp_number = config_update.whatsapp_number  # ← NUEVO

    
    db.commit()
    return {"message": "Configuration updated successfully"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
-----------------------------------------------------
####index.html###
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="-DYMsGfGP_2KBzFnLMopMEjczvkwpEZ4Y7SVxk9VV5A" />
    <meta name="description" content="El Rincón de la Sole - Descubre productos únicos y especiales seleccionados con cariño">
    <meta name="keywords" content="productos, tienda, el rincón de la sole, artesanía, especial">
    <meta name="author" content="El Rincón de la Sole">
    <meta property="og:title" content="El Rincón de la Sole">
    <meta property="og:description" content="Descubre productos únicos y especiales">
    <meta property="og:type" content="website">
    <title>El Rincón de la Sole - Productos Únicos</title>
    <link rel="stylesheet" href="/static/css/style.css">

    <style>
        :root {
            --primary-color: {{ config.primary_color }};
            --background-color: {{ config.background_color }};
            --product-bg-color: {{ config.product_bg_color }};
        }

        /* BOTÓN WHATSAPP FLOTANTE */
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 25px;
            right: 25px;
            background-color: #25d366;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s ease-in-out;
        }
        .whatsapp-float:hover {
            transform: scale(1.1);
        }
        .whatsapp-float img {
            width: 35px;
            height: 35px;
        }

        /* CONTACTO EN HERO */
        .contact-line {
            margin-top: 12px;
            font-size: 20px;
            font-weight: bold;
        }

        .whatsapp-inline {
            display: inline-flex;
            align-items: center;
            margin-left: 6px;
            padding: 6px 10px;
            background: #25d366;
            color: #fff;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
        }

        .whatsapp-inline img {
            width: 22px;
            height: 22px;
            margin-right: 5px;
        }
    </style>

</head>
<body>
    <header>
        <nav>
            <div class="container">
                <h1 class="logo">El Rincón de la Sole</h1>
                <a href="/login" class="admin-link">Administrador</a>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <h2>Bienvenidos a El Rincón de la Sole</h2>
                <p>Descubre productos únicos seleccionados especialmente para ti</p>

                <p class="contact-line">
                    Contactanos:
                    <a href="https://wa.me/54{{ config.whatsapp_number }}" target="_blank" class="whatsapp-inline">
                        <img src="/static/img/whatsapp.png" alt="WhatsApp">
                        {{ config.whatsapp_number }}
                    </a>
                </p>
            </div>
        </section>

        <section class="products">
            <div class="container">
                <h3>Nuestros Productos</h3>
                
                {% if products %}
                <div class="products-grid">
                    {% for product in products %}
                    <div class="product-card">
                        {% if product.image %}
                        <img src="data:image/jpeg;base64,{{ product.image }}" alt="{{ product.name }}">
                        {% else %}
                        <div class="no-image">Sin imagen</div>
                        {% endif %}
                        <div class="product-info">
                            <h4>{{ product.name }}</h4>
                            {% if product.description %}
                            <p class="description">{{ product.description }}</p>
                            {% endif %}
                            {% if product.price %}
                            <p class="price">${{ "%.2f"|format(product.price) }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <p class="no-products">No hay productos disponibles por el momento.</p>
                {% endif %}
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 El Rincón de la Sole. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- BOTÓN WHATSAPP FLOTANTE -->
    <a href="https://wa.me/54{{ config.whatsapp_number }}" class="whatsapp-float" target="_blank">
        <img src="/static/img/whatsapp.png" alt="WhatsApp">
    </a>

</body>
</html>
##dashboard.html####
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Dashboard - El Rincón de la Sole</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <nav>
            <div class="container">
                <h1 class="logo">El Rincón de la Sole</h1>
                <div class="nav-links">
                    <a href="/" target="_blank">Ver Sitio</a>
                    <button id="logoutBtn" class="btn-secondary">Cerrar Sesión</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="container">

            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="products">Productos</button>
                <button class="tab-btn" data-tab="config">Configuración</button>
            </div>

            <!-- TAB PRODUCTOS -->
            <div id="products-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Gestión de Productos</h2>
                    <button id="addProductBtn" class="btn-primary">+ Agregar Producto</button>
                </div>

                <div id="productsList" class="products-list"></div>

                <!-- MODAL AGREGAR/EDITAR -->
                <div id="productModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3 id="modalTitle">Agregar Producto</h3>

                        <form id="productForm" enctype="multipart/form-data">
                            <input type="hidden" id="productId">

                            <div class="form-group">
                                <label for="productName">Nombre *</label>
                                <input type="text" id="productName" required>
                            </div>

                            <div class="form-group">
                                <label for="productDescription">Descripción</label>
                                <textarea id="productDescription" rows="4"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="productPrice">Precio</label>
                                <input type="number" id="productPrice" step="0.01" min="0">
                            </div>

                            <div class="form-group">
                                <label for="productImage">Imagen *</label>
                                <input type="file" id="productImage" accept="image/*">
                                <img id="imagePreview" style="display:none; max-width:200px; margin-top:10px;">
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Guardar</button>
                                <button type="button" class="btn-secondary" onclick="closeProductModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TAB CONFIGURACIÓN -->
            <div id="config-tab" class="tab-content">

                <h2>Configuración del Sitio</h2>

                <form id="configForm">

                    <div class="form-group">
                        <label for="primaryColor">Color Principal</label>
                        <input type="color" id="primaryColor">
                    </div>

                    <div class="form-group">
                        <label for="backgroundColor">Color de Fondo</label>
                        <input type="color" id="backgroundColor">
                    </div>

                    <div class="form-group">
                        <label for="productBgColor">Color Fondo de Productos</label>
                        <input type="color" id="productBgColor">
                    </div>

                    <!-- NUEVO CAMPO WHATSAPP -->
                    <div class="form-group">
                        <label for="whatsappNumber">Número de WhatsApp</label>
                        <input type="text" id="whatsappNumber" placeholder="Ej: 1121820759">
                    </div>

                    <button type="submit" class="btn-primary">Guardar Configuración</button>
                </form>

            </div>

            <div id="message" class="message"></div>

        </div>
    </main>

    <script src="/static/js/dashboard.js"></script>
</body>
</html>
---------------------------------------------------
##login##
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Login - El Rincón de la Sole</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <h2>Iniciar Sesión</h2>
            <p class="subtitle">Panel de Administración</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
            
            <div class="auth-links">
                <a href="/forgot-password">¿Olvidaste tu contraseña?</a>
                <a href="/">Volver al inicio</a>
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('message');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    messageDiv.textContent = 'Inicio de sesión exitoso. Redirigiendo...';
                    messageDiv.className = 'message success';
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    messageDiv.textContent = data.detail || 'Error al iniciar sesión';
                    messageDiv.className = 'message error';
                }
            } catch (error) {
                messageDiv.textContent = 'Error de conexión';
                messageDiv.className = 'message error';
            }
        });
    </script>
</body>
</html>
----------------------------------------
##forgot_password##
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Recuperar Contraseña - El Rincón de la Sole</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <h2>Recuperar Contraseña</h2>
            <p class="subtitle">Ingresa tu correo electrónico</p>
            
            <form id="forgotForm">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <button type="submit" class="btn-primary">Enviar Enlace</button>
            </form>
            
            <div class="auth-links">
                <a href="/login">Volver al login</a>
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const messageDiv = document.getElementById('message');
            
            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.textContent = 'Si el correo existe, recibirás un enlace para restablecer tu contraseña.';
                    messageDiv.className = 'message success';
                    document.getElementById('forgotForm').reset();
                } else {
                    messageDiv.textContent = data.detail || 'Error al procesar la solicitud';
                    messageDiv.className = 'message error';
                }
            } catch (error) {
                messageDiv.textContent = 'Error de conexión';
                messageDiv.className = 'message error';
            }
        });
    </script>
</body>
</html>
-----------------------------------
##reset_password##
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Restablecer Contraseña - El Rincón de la Sole</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <h2>Restablecer Contraseña</h2>
            <p class="subtitle">Ingresa tu nueva contraseña</p>
            
            <form id="resetForm">
                <input type="hidden" id="token" value="{{ token }}">
                
                <div class="form-group">
                    <label for="new_password">Nueva Contraseña</label>
                    <input type="password" id="new_password" name="new_password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirmar Contraseña</label>
                    <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
                </div>
                
                <button type="submit" class="btn-primary">Restablecer</button>
            </form>
            
            <div class="auth-links">
                <a href="/login">Volver al login</a>
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = document.getElementById('token').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const messageDiv = document.getElementById('message');
            
            if (newPassword !== confirmPassword) {
                messageDiv.textContent = 'Las contraseñas no coinciden';
                messageDiv.className = 'message error';
                return;
            }
            
            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token, new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.textContent = 'Contraseña restablecida exitosamente. Redirigiendo...';
                    messageDiv.className = 'message success';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    messageDiv.textContent = data.detail || 'Error al restablecer la contraseña';
                    messageDiv.className = 'message error';
                }
            } catch (error) {
                messageDiv.textContent = 'Error de conexión';
                messageDiv.className = 'message error';
            }
        });
    </script>
</body>
</html>
---------------------------
##static/css/style.css###
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #ff6b9d;
    --background-color: #fff5f8;
    --product-bg-color: #ffffff;
    --text-color: #333;
    --border-color: #e0e0e0;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Header */
header {
    background: white;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

nav {
    padding: 1rem 0;
}

nav .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    color: var(--primary-color);
    font-size: 1.8rem;
    font-weight: bold;
}

.admin-link, .nav-links a {
    color: var(--primary-color);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border: 2px solid var(--primary-color);
    border-radius: 5px;
    transition: all 0.3s;
}

.admin-link:hover, .nav-links a:hover {
    background: var(--primary-color);
    color: white;
}

.nav-links {
    display: flex;
    gap: 1rem;
    align-items: center;
}

/* Hero Section */
.hero {
    background: linear-gradient(135deg, var(--primary-color), #ff9dbf);
    color: white;
    padding: 4rem 0;
    text-align: center;
}

.hero h2 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.hero p {
    font-size: 1.2rem;
    opacity: 0.95;
}

/* Products Section */
.products {
    padding: 3rem 0;
}

.products h3 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 2rem;
    color: var(--primary-color);
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
}

.product-card {
    background: var(--product-bg-color);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: transform 0.3s;
}

.product-card:hover {
    transform: translateY(-5px);
}

.product-card img, .no-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
}

.no-image {
    background: var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
}

.product-info {
    padding: 1.5rem;
}

.product-info h4 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
    color: var(--primary-color);
}

.product-info .description {
    color: #666;
    margin-bottom: 1rem;
}

.product-info .price {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color);
}

.no-products {
    text-align: center;
    font-size: 1.2rem;
    color: #999;
    padding: 3rem 0;
}

/* Footer */
footer {
    background: white;
    padding: 2rem 0;
    margin-top: 3rem;
    text-align: center;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
}

/* Auth Pages */
.auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth-card {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: var(--shadow);
    width: 100%;
    max-width: 400px;
}

.auth-card h2 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.auth-card .subtitle {
    color: #666;
    margin-bottom: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
}

.btn-primary, .btn-secondary {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    width: 100%;
}

.btn-primary:hover {
    background: #ff5289;
}

.btn-secondary {
    background: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-secondary:hover {
    background: var(--background-color);
}

.auth-links {
    margin-top: 1.5rem;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.auth-links a {
    color: var(--primary-color);
    text-decoration: none;
}

.auth-links a:hover {
    text-decoration: underline;
}

.message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 5px;
    display: none;
}

.message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

/* Dashboard */
.dashboard {
    padding: 2rem 0;
}

.dashboard-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    padding: 1rem 2rem;
    background: none;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.products-list {
    display: grid;
    gap: 1rem;
}

.product-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: var(--shadow);
    display: flex;
    gap: 1rem;
    align-items: center;
}

.product-item img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
}

.product-item-info {
    flex: 1;
}

.product-item-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-edit, .btn-delete {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-edit {
    background: #ffc107;
    color: white;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
    float: right;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    color: #999;
}

.close:hover {
    color: #333;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.form-actions button {
    flex: 1;
}

/* Responsive */
@media (max-width: 768px) {
    .hero h2 {
        font-size: 2rem;
    }
    
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .nav-links {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .section-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .product-item {
        flex-direction: column;
    }
}

-------------------------
##static/css/dashboard.js###
// =========================
//   VERIFICAR AUTENTICACIÓN
// =========================
const token = localStorage.getItem('token');
if (!token) {
    window.location.href = '/login';
}

const authHeaders = {
    'Authorization': `Bearer ${token}`
};

// =========================
//   VARIABLES GLOBALES
// =========================
let currentEditId = null;

// =========================
//   TABS
// =========================
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'products') loadProducts();
        if (tabName === 'config') loadConfig();
    });
});

// =========================
//   LOGOUT
// =========================
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = '/login';
});

// =========================
//   CARGAR PRODUCTOS
// =========================
async function loadProducts() {
    try {
        const response = await fetch('/api/products', {
            headers: authHeaders
        });

        if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
        }

        const products = await response.json();
        const productsList = document.getElementById('productsList');

        if (products.length === 0) {
            productsList.innerHTML = '<p class="no-products">No hay productos. Agrega el primero.</p>';
            return;
        }

        productsList.innerHTML = products.map(p => `
            <div class="product-item">
                <img src="data:image/jpeg;base64,${p.image}" alt="${p.name}">
                <div class="product-item-info">
                    <h4>${p.name}</h4>
                    ${p.description ? `<p>${p.description}</p>` : ''}
                    ${p.price ? `<p><strong>$${p.price.toFixed(2)}</strong></p>` : ''}
                </div>
                <div class="product-item-actions">
                    <button class="btn-edit" onclick="editProduct(${p.id})">Editar</button>
                    <button class="btn-delete" onclick="deleteProduct(${p.id})">Eliminar</button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        showMessage('Error al cargar productos', 'error');
    }
}

// =========================
//   MODAL PRODUCTOS
// =========================
const modal = document.getElementById('productModal');
const addBtn = document.getElementById('addProductBtn');
const closeBtn = document.querySelector('.close');

addBtn.onclick = () => {
    currentEditId = null;
    document.getElementById('modalTitle').textContent = 'Agregar Producto';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('productImage').required = true;
    modal.classList.add('active');
};

closeBtn.onclick = closeProductModal;

window.onclick = (e) => {
    if (e.target === modal) closeProductModal();
};

function closeProductModal() {
    modal.classList.remove('active');
}

// =========================
//   PREVIEW IMAGEN
// =========================
document.getElementById('productImage').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('imagePreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// =========================
//   GUARDAR PRODUCTO
// =========================
document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append('name', document.getElementById('productName').value);
    formData.append('description', document.getElementById('productDescription').value);
    formData.append('price', document.getElementById('productPrice').value || '');

    const imageFile = document.getElementById('productImage').files[0];
    if (imageFile) formData.append('image', imageFile);

    try {
        let url = '/api/products';
        let method = 'POST';

        if (currentEditId) {
            url = `/api/products/${currentEditId}`;
            method = 'PUT';
        }

        const response = await fetch(url, {
            method,
            headers: authHeaders,
            body: formData
        });

        if (response.ok) {
            showMessage('Producto guardado exitosamente', 'success');
            closeProductModal();
            loadProducts();
        } else {
            const data = await response.json();
            showMessage(data.detail || 'Error al guardar producto', 'error');
        }
    } catch (error) {
        showMessage('Error de conexión', 'error');
    }
});

// =========================
//   EDITAR PRODUCTO
// =========================
async function editProduct(id) {
    try {
        const response = await fetch('/api/products', {
            headers: authHeaders
        });
        const products = await response.json();
        const product = products.find(p => p.id === id);

        if (product) {
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Editar Producto';
            document.getElementById('productId').value = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productImage').required = false;

            if (product.image) {
                const preview = document.getElementById('imagePreview');
                preview.src = `data:image/jpeg;base64,${product.image}`;
                preview.style.display = 'block';
            }

            modal.classList.add('active');
        }
    } catch (error) {
        showMessage('Error al cargar producto', 'error');
    }
}

// =========================
//   ELIMINAR PRODUCTO
// =========================
async function deleteProduct(id) {
    if (!confirm('¿Estás seguro de eliminar este producto?')) return;

    try {
        const response = await fetch(`/api/products/${id}`, {
            method: 'DELETE',
            headers: authHeaders
        });

        if (response.ok) {
            showMessage('Producto eliminado exitosamente', 'success');
            loadProducts();
        } else {
            showMessage('Error al eliminar producto', 'error');
        }
    } catch (error) {
        showMessage('Error de conexión', 'error');
    }
}

// =========================
//   CARGAR CONFIGURACIÓN
// =========================
async function loadConfig() {
    try {
        const response = await fetch('/api/config');
        const config = await response.json();

        document.getElementById('primaryColor').value = config.primary_color;
        document.getElementById('backgroundColor').value = config.background_color;
        document.getElementById('productBgColor').value = config.product_bg_color;

        // ⭐ NUEVO: WhatsApp
        document.getElementById('whatsappNumber').value = config.whatsapp_number || '';

    } catch (error) {
        showMessage('Error al cargar configuración', 'error');
    }
}

// =========================
//   GUARDAR CONFIGURACIÓN
// =========================
document.getElementById('configForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const config = {
        primary_color: document.getElementById('primaryColor').value,
        background_color: document.getElementById('backgroundColor').value,
        product_bg_color: document.getElementById('productBgColor').value,
        
        // ⭐ NUEVO
        whatsapp_number: document.getElementById('whatsappNumber').value
    };

    try {
        const response = await fetch('/api/config', {
            method: 'PUT',
            headers: {
                ...authHeaders,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });

        if (response.ok) {
            showMessage('Configuración guardada exitosamente', 'success');
        } else {
            showMessage('Error al guardar configuración', 'error');
        }
    } catch (error) {
        showMessage('Error de conexión', 'error');
    }
});

// =========================
//   NOTIFICACIONES
// =========================
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;

    setTimeout(() => {
        messageDiv.className = 'message';
    }, 4000);
}

// =========================
//   INICIALIZAR
// =========================
loadProducts();
-------------------------
##static/css/robots.txt###
User-agent: *
Allow: /
Sitemap: https://el-rincon-de-la-sole.onrender.com/static/sitemap.xml
----------------------------------------
###render.yaml
services:
  - type: web
    name: el-rincon-de-la-sole
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: SECRET_KEY
        generateValue: true
      - key: SMTP_SERVER
        value: smtp.gmail.com
      - key: SMTP_PORT
        value: 587
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: BASE_URL
        sync: false
----------------------------------------
###runtime.txt
python-3.11.9
